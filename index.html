<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>User Panel ‚Äì Live Quiz</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;}
body{margin:0;font-family:Arial,sans-serif;background:#0f172a;color:white;}
.box{width:95%;max-width:500px;margin:20px auto;background:#1e293b;padding:16px;border-radius:12px;}
h2{text-align:center;font-size:22px;}
h3{font-size:18px;}
input,button{width:100%;padding:12px;margin:8px 0;border-radius:8px;font-size:15px;border:none;}
input{background:#020617;color:white;border:1px solid #334155;}
button{background:#334155;color:white;cursor:pointer;}
button:hover{background:#475569;}
#options button{margin:6px 0;}
.option-selected{background:#22c55e!important;color:#020617;font-weight:bold;}
#startBox,#quizBox,#resultBox{display:none;}
</style>
</head>

<body>
<div class="box">
<h2>Live Quiz by Jpr Guddu</h2>

<!-- AUTH -->
<div id="authBox">
  <div id="signUpDiv">
    <h3>Sign Up</h3>
    <input id="suName" placeholder="Name">
    <input id="suEmail" placeholder="Email">
    <input id="suPass" type="password" placeholder="Password">
    <button onclick="signUp()">Sign Up</button>
    <p onclick="showSignIn()" style="cursor:pointer;color:#38bdf8">Already have ID?</p>
  </div>

  <div id="signInDiv" style="display:none">
    <h3>Sign In</h3>
    <input id="siId" placeholder="User ID">
    <input id="siPass" type="password" placeholder="Password">
    <button onclick="signIn()">Sign In</button>
    <p onclick="showSignUp()" style="cursor:pointer;color:#38bdf8">Create new ID</p>
  </div>
</div>

<!-- START -->
<div id="startBox">
<p>üë§ <span id="userShow"></span></p>
<p>Status: <b><span id="quizStatus">--</span></b></p>
<p>‚è± Time Left: <span id="timeLeft">--</span></p>
<button onclick="startQuiz()">Start Quiz</button>
</div>

<!-- QUIZ -->
<div id="quizBox">
<p>Question Time: <span id="qTime">30</span>s</p>
<h3 id="question"></h3>
<div id="options"></div>
<button id="nextBtn" onclick="nextQ()" disabled>Next</button>
</div>

<!-- RESULT -->
<div id="resultBox">
<h3 id="scoreText"></h3>
</div>
</div>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, collection, setDoc, getDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig={
  apiKey:"AIzaSyA9jEFAe9gyM4Y8ijNq3I9UXfnpwTakrPc",
  authDomain:"mystorage-c9eeb.firebaseapp.com",
  projectId:"mystorage-c9eeb"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth();

/* ================= QUIZ ID ================= */
const quizId=new URLSearchParams(location.search).get("quizId");
if(!quizId){ alert("Quiz ID missing"); throw new Error("quizId missing"); }

/* ================= GLOBAL ================= */
let uid="", username="", email="";
let questions=[], index=0, score=0, selected=null;
let qTimer=null, qTime=30, startTime=0, endTime=0;

/* ================= UI ================= */
window.showSignUp=()=>{signUpDiv.style.display="block";signInDiv.style.display="none";}
window.showSignIn=()=>{signUpDiv.style.display="none";signInDiv.style.display="block";}

/* ================= SIGN UP ================= */
window.signUp=async()=>{
  const cred=await createUserWithEmailAndPassword(auth,suEmail.value,suPass.value);
  uid=cred.user.uid;
  username=suName.value; email=suEmail.value;

  let userId;
  while(true){
    userId=Math.floor(100000+Math.random()*900000).toString();
    if(!(await getDoc(doc(db,"users",userId))).exists()) break;
  }

  await setDoc(doc(db,"users",userId),{uid,username,email});
  alert("Your User ID: "+userId);
  showStart();
};

/* ================= SIGN IN ================= */
window.signIn=async()=>{
  const snap=await getDoc(doc(db,"users",siId.value));
  if(!snap.exists()){alert("Invalid ID");return;}
  uid=snap.data().uid;
  username=snap.data().username;
  email=snap.data().email;
  await signInWithEmailAndPassword(auth,email,siPass.value);
  showStart();
};

/* ================= START SCREEN ================= */
async function showStart(){
  authBox.style.display="none";
  startBox.style.display="block";
  userShow.innerText=username;

  const qc=(await getDoc(doc(db,"liveQuiz",quizId))).data()?.quizControl;
  startTime=qc.startTime;
  endTime=qc.endTime;

  setInterval(()=>{
    const now=Date.now();
    if(now<startTime){quizStatus.innerText="Waiting";}
    else if(now<=endTime){quizStatus.innerText="Running";}
    else{quizStatus.innerText="Ended";}
  },1000);
}

/* ================= START QUIZ ================= */
window.startQuiz=async()=>{
  if(Date.now()<startTime||Date.now()>endTime){alert("Quiz not running");return;}
  startBox.style.display="none";
  quizBox.style.display="block";

  await setDoc(doc(db,"liveQuiz",quizId,"liveUsers",uid),{username});

  const qs=await getDocs(collection(db,"liveQuiz",quizId,"questions"));
  qs.forEach(d=>questions.push(d.data()));
  loadQ();
};

/* ================= QUESTIONS ================= */
function loadQ(){
  if(index>=questions.length){finish();return;}
  const q=questions[index];
  question.innerText=q.question;
  options.innerHTML="";
  q.o.forEach((x,i)=>{
    const b=document.createElement("button");
    b.innerText=x;
    b.onclick=()=>select(i,b);
    options.appendChild(b);
  });
  nextBtn.disabled=true;

  clearInterval(qTimer);
  qTime=30; qTimeShow();
  qTimer=setInterval(()=>{
    qTime--; qTimeShow();
    if(qTime<=0){nextQ();}
  },1000);
}

function qTimeShow(){qTime.innerText=qTime;}
window.select=(i,b)=>{
  selected=i;
  document.querySelectorAll("#options button").forEach(x=>x.classList.remove("option-selected"));
  b.classList.add("option-selected");
  nextBtn.disabled=false;
};

window.nextQ=()=>{
  clearInterval(qTimer);
  if(Number(selected)===Number(questions[index].answer)) score++;
  index++; selected=null;
  loadQ();
};

/* ================= FINISH ================= */
async function finish(){
  quizBox.style.display="none";
  resultBox.style.display="block";
  await deleteDoc(doc(db,"liveQuiz",quizId,"liveUsers",uid));
  await setDoc(doc(db,"liveQuiz",quizId,"results",uid),{username,score});
  scoreText.innerHTML=`Score: <b>${score}</b>`;
}
</script>
</body>
</html>
